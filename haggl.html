<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haggl- Logistics Brokerage Firm</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slide-in-right {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .animate-in { animation: fade-in-up 0.5s ease-out; }
        .slide-in { animation: slide-in-right 0.3s ease-out; }
        
        /* Map Container */
        #map-container {
            height: 100%;
            width: 100%;
            z-index: 0;
            background-color: #e2e8f0;
        }
        
        /* Hide Leaflet Routing Container */
        .leaflet-routing-container { display: none !important; }
        
        .custom-div-icon { background: transparent; border: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const BRAND_COLOR = "#FFCC00";

        // --- ICONS ---
        const Icons = {
            MapPin: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Settings: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            SearchCode: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m13 13.5 2-2.5-2-2.5"/><path d="m21 21-4.3-4.3"/><path d="M9 8.5 7 11l2 2.5"/><circle cx="11" cy="11" r="8"/></svg>,
            Loader2: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Package: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></svg>,
            Truck: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 17h4V5H2v12h3"/><path d="M20 17h2v-3.34a4 4 0 0 0-1.17-2.83L19 9h-5"/><path d="M14 17h1"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>,
            Navigation: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Menu: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Crosshair: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>,
            WifiOff: ({ size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 2 22 22"/><path d="M8.5 8.5A6 6 0 0 1 19 12"/><path d="M5 12a10 10 0 0 1 15.828-5.828"/><path d="M12 20a14 14 0 0 1-9.9-4.1"/></svg>
        };

        // --- ADDRESS FORM COMPONENT ---
        const AddressForm = ({ type, data, onChange, onCoordsUpdate }) => {
            const [isLoadingPin, setIsLoadingPin] = useState(false);
            const [isLoadingGeo, setIsLoadingGeo] = useState(false);
            const [geoError, setGeoError] = useState('');
            const [localities, setLocalities] = useState([]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                onChange({ ...data, [name]: value });
            };

            const handleManualCoords = (e) => {
                const val = e.target.value;
                onChange({ ...data, manualCoords: val });
            };

            const handlePincodeSearch = async () => {
                if (data.pincode.length !== 6) return;
                setIsLoadingPin(true);
                setLocalities([]); // Clear previous
                try {
                    const res = await fetch(`https://api.postalpincode.in/pincode/${data.pincode}`);
                    const json = await res.json();
                    if (json && json[0].Status === "Success") {
                        const poList = json[0].PostOffice;
                        const main = poList[0];
                        
                        // Populate Locality Dropdown
                        const locs = poList.map(po => po.Name);
                        setLocalities(locs);

                        onChange({
                            ...data,
                            district: main.District,
                            state: main.State,
                            block: main.Block !== "NA" ? main.Block : main.Taluk || main.Division,
                            locality: locs.length > 0 ? locs[0] : ''
                        });
                    } else {
                        setGeoError("Invalid Pincode");
                    }
                } catch (e) { console.error(e); setGeoError("API Error"); }
                setIsLoadingPin(false);
            };

            const handleGeocode = async () => {
                setIsLoadingGeo(true);
                setGeoError('');

                // 1. PRIORITY: Check Manual GPS Coordinates first
                if (data.manualCoords && data.manualCoords.trim()) {
                    const parts = data.manualCoords.split(',').map(s => s.trim());
                    if (parts.length === 2) {
                        const lat = parseFloat(parts[0]);
                        const lng = parseFloat(parts[1]);
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            // If valid coordinates, use them immediately
                            onCoordsUpdate(lat, lng);
                            setIsLoadingGeo(false);
                            return; 
                        } else {
                            setGeoError('Invalid format. Use: 9.768, 78.068');
                            setIsLoadingGeo(false);
                            return;
                        }
                    }
                }
                
                // 2. FALLBACK: Geocode based on Address fields
                // Construct query from 4 main fields
                const queryParts = [
                    data.locality,
                    data.block,
                    data.district,
                    data.state,
                    'India'
                ].filter(Boolean);
                
                const query = queryParts.join(', ');
                
                if (!query) {
                    setGeoError('Please enter details or coordinates');
                    setIsLoadingGeo(false);
                    return;
                }

                try {
                    // Using Nominatim for Geocoding
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                    const res = await fetch(url);
                    const json = await res.json();
                    
                    if (json && json.length > 0) {
                        const lat = parseFloat(json[0].lat);
                        const lng = parseFloat(json[0].lon);
                        onCoordsUpdate(lat, lng);
                    } else {
                        setGeoError('Address not found. Try Pincode search first.');
                    }
                } catch (e) {
                    setGeoError('Network error during geocoding.');
                }
                setIsLoadingGeo(false);
            };

            return (
                <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3">
                    <div className="flex items-center gap-2 mb-2">
                        <div className={`p-1.5 rounded-lg ${type === 'pickup' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600'}`}>
                            {type === 'pickup' ? <Icons.Package size={16}/> : <Icons.MapPin size={16}/>}
                        </div>
                        <h3 className="font-bold text-gray-700 uppercase text-xs tracking-wider">{type} Details</h3>
                        {data.lat && <span className="ml-auto text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">Coordinates Set</span>}
                    </div>

                    <div className="space-y-3">
                        {/* Pincode Search Row */}
                        <div>
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Pincode (Search)</label>
                            <div className="flex gap-2">
                                <input 
                                    type="text" name="pincode" value={data.pincode} onChange={handleChange}
                                    placeholder="600001" maxLength="6"
                                    className="w-full bg-slate-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-[#FFCC00] outline-none font-mono"
                                />
                                <button 
                                    onClick={handlePincodeSearch}
                                    disabled={data.pincode.length !== 6 || isLoadingPin}
                                    className="bg-slate-100 px-3 rounded-lg hover:bg-slate-200 transition-colors text-slate-600"
                                >
                                    {isLoadingPin ? <Icons.Loader2 className="animate-spin" /> : <Icons.SearchCode />}
                                </button>
                            </div>
                        </div>

                        {/* Locality Dropdown */}
                        <div>
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Locality / Area</label>
                            <select 
                                name="locality" 
                                value={data.locality} 
                                onChange={handleChange}
                                className="w-full bg-slate-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-[#FFCC00] outline-none"
                            >
                                <option value="">Select Area</option>
                                {localities.map((loc, idx) => (
                                    <option key={idx} value={loc}>{loc}</option>
                                ))}
                                {localities.length === 0 && data.locality && <option value={data.locality}>{data.locality}</option>}
                            </select>
                        </div>

                        {/* Block & District */}
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">Taluk / Block</label>
                                <input type="text" name="block" value={data.block} onChange={handleChange} className="w-full bg-slate-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none" />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">District</label>
                                <input type="text" name="district" value={data.district} onChange={handleChange} className="w-full bg-slate-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none" />
                            </div>
                        </div>

                        {/* State */}
                        <div>
                            <label className="text-[10px] font-bold text-gray-400 uppercase">State</label>
                            <input type="text" name="state" value={data.state} onChange={handleChange} className="w-full bg-slate-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none" />
                        </div>
                        
                        {/* Manual GPS Coordinates */}
                        <div>
                            <label className="text-[10px] font-bold text-gray-400 uppercase flex items-center gap-1">
                                <Icons.Crosshair size={10} />
                                GPS Coordinates (Optional)
                            </label>
                            <input 
                                type="text" 
                                name="manualCoords" 
                                value={data.manualCoords || ''} 
                                onChange={handleManualCoords}
                                placeholder="eg: 9.768, 78.068" 
                                className="w-full bg-slate-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-600 outline-none focus:border-[#FFCC00]" 
                            />
                        </div>

                        {/* Radius Slider */}
                        <div>
                             <div className="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-1">
                                <span>Geofence Radius</span>
                                <span className={`${type === 'pickup' ? 'text-amber-600' : 'text-blue-600'}`}>{data.radius} meters</span>
                            </div>
                            <input 
                                type="range" 
                                min="10" 
                                max="2000" 
                                step="10" 
                                value={data.radius} 
                                onChange={(e) => onChange({ ...data, radius: parseInt(e.target.value) })}
                                className={`w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer ${type === 'pickup' ? 'accent-amber-500' : 'accent-blue-600'}`}
                            />
                        </div>
                    </div>

                    {geoError && <p className="text-xs text-red-500 font-medium">{geoError}</p>}

                    <button 
                        onClick={handleGeocode}
                        disabled={isLoadingGeo || (!data.locality && !data.manualCoords)}
                        className={`w-full py-2.5 rounded-lg text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 transition-all
                            ${isLoadingGeo ? 'bg-gray-100 text-gray-400' : 'bg-slate-800 text-white hover:bg-slate-900'}
                        `}
                    >
                        {isLoadingGeo ? <Icons.Loader2 className="animate-spin" /> : <Icons.MapPin size={14} />}
                        {data.lat ? 'Update Coordinates' : 'Fetch Coordinates'}
                    </button>
                    
                    {data.lat && (
                         <p className="text-[10px] text-center text-gray-400 font-mono">
                            {data.lat.toFixed(5)}, {data.lng.toFixed(5)}
                         </p>
                    )}
                </div>
            );
        };

        // --- MAP COMPONENT ---
        const MapComponent = ({ targetLat, targetLng, radius, driverLocation, driverAccuracy, onRouteFound }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({ target: null, driver: null, accuracyCircle: null });
            const circleRef = useRef(null);
            const routingControlRef = useRef(null);

            useEffect(() => {
                // Initialize Map
                if (!mapInstanceRef.current && mapRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current, { zoomControl: false }).setView([20.5937, 78.9629], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(mapInstanceRef.current);
                    setTimeout(() => mapInstanceRef.current.invalidateSize(), 500);
                }

                const map = mapInstanceRef.current;
                if (!map) return;

                // --- 1. Target Marker & Circle (Pickup or Drop) ---
                if (targetLat && targetLng) {
                    if (markersRef.current.target) map.removeLayer(markersRef.current.target);
                    if (circleRef.current) map.removeLayer(circleRef.current);
                    
                    const targetIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #4f46e5; width: 16px; height: 16px; border: 3px solid white; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [16, 16], iconAnchor: [8, 8]
                    });
                    
                    markersRef.current.target = L.marker([targetLat, targetLng], { icon: targetIcon }).addTo(map);
                    
                    // Add Geofence Circle
                    circleRef.current = L.circle([targetLat, targetLng], {
                        color: '#6366f1',
                        fillColor: '#6366f1',
                        fillOpacity: 0.15,
                        radius: radius || 500
                    }).addTo(map);
                }

                // --- 2. Driver Marker & Accuracy Circle ---
                if (driverLocation) {
                    if (markersRef.current.driver) map.removeLayer(markersRef.current.driver);
                    if (markersRef.current.accuracyCircle) map.removeLayer(markersRef.current.accuracyCircle);
                    
                    const driverIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #FFCC00; width: 20px; height: 20px; border: 3px solid black; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; font-size:10px;">ðŸš›</div>`,
                        iconSize: [20, 20], iconAnchor: [10, 10]
                    });
                    
                    markersRef.current.driver = L.marker([driverLocation.lat, driverLocation.lng], { icon: driverIcon }).addTo(map);

                    // Add Accuracy Circle (Visual Uncertainty Zone)
                    if (driverAccuracy) {
                         markersRef.current.accuracyCircle = L.circle([driverLocation.lat, driverLocation.lng], {
                             color: '#F59E0B', // Amber
                             fillColor: '#F59E0B',
                             fillOpacity: 0.15,
                             weight: 1,
                             dashArray: '4, 4',
                             radius: driverAccuracy
                         }).addTo(map);
                    }
                }

                // --- 3. Routing ---
                if (targetLat && targetLng && driverLocation) {
                    if (routingControlRef.current) map.removeControl(routingControlRef.current);

                    routingControlRef.current = L.Routing.control({
                        waypoints: [
                            L.latLng(driverLocation.lat, driverLocation.lng),
                            L.latLng(targetLat, targetLng)
                        ],
                        lineOptions: { styles: [{ color: '#6366f1', opacity: 0.8, weight: 6 }] },
                        createMarker: () => null, // Hide default markers
                        addWaypoints: false,
                        show: false
                    })
                    .on('routesfound', function(e) {
                        const routes = e.routes;
                        const summary = routes[0].summary;
                        onRouteFound(summary.totalDistance, summary.totalTime); // meters, seconds
                    })
                    .addTo(map);
                } else {
                     if (targetLat && targetLng && !driverLocation) {
                        map.flyTo([targetLat, targetLng], 14);
                     }
                }

            }, [targetLat, targetLng, radius, driverLocation, driverAccuracy]);

            return <div ref={mapRef} id="map-container" className="w-full h-full"></div>;
        };

        // --- MAIN APP ---
        const GeoFenceApp = () => {
            const [view, setView] = useState('admin'); // 'admin' | 'driver'
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            // LOGISTICS STATE
            const [status, setStatus] = useState('PICKUP'); // 'PICKUP' | 'DROP'
            
            // LOCATIONS
            const [pickup, setPickup] = useState({ pincode: '', district: '', state: '', block: '', locality: '', lat: null, lng: null, radius: 500, manualCoords: '' });
            const [drop, setDrop] = useState({ pincode: '', district: '', state: '', block: '', locality: '', lat: null, lng: null, radius: 500, manualCoords: '' });
            
            // DRIVER STATE
            const [driverLocation, setDriverLocation] = useState(null);
            const [driverSearching, setDriverSearching] = useState(false);
            const [driverAccuracy, setDriverAccuracy] = useState(null);
            
            // ROUTE STATS
            const [routeStats, setRouteStats] = useState({ distance: 0, time: 0 }); // distance in m, time in s

            // Determine current target based on status
            const activeTarget = status === 'PICKUP' ? pickup : drop;
            
            const handleDriverCheckIn = () => {
                setDriverSearching(true);
                if (!navigator.geolocation) { alert("GPS not supported"); return; }
                
                navigator.geolocation.getCurrentPosition((pos) => {
                    const { latitude, longitude, accuracy } = pos.coords;
                    setDriverLocation({ lat: latitude, lng: longitude });
                    setDriverAccuracy(accuracy);
                    setDriverSearching(false);

                    // WARN IF ACCURACY IS POOR (Typical on Desktop/PC without GPS)
                    if (accuracy > 100) {
                        alert(`âš ï¸ Low GPS Accuracy (Â±${Math.round(accuracy)}m)\n\nWe detected low accuracy. This usually happens on PC/Laptops using IP location.\n\nFor precise tracking, please open this app on a Mobile Phone with GPS enabled.`);
                    }

                }, (err) => {
                    alert("GPS Error: " + err.message);
                    setDriverSearching(false);
                }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
            };

            const formatTime = (seconds) => {
                if (!seconds) return '0 min';
                
                const d = Math.floor(seconds / (3600 * 24));
                const h = Math.floor((seconds % (3600 * 24)) / 3600);
                const m = Math.floor((seconds % 3600) / 60);

                let parts = [];
                if (d > 0) parts.push(`${d} day${d > 1 ? 's' : ''}`);
                if (h > 0) parts.push(`${h} hour${h > 1 ? 's' : ''}`);
                if (m > 0 || (d===0 && h===0)) parts.push(`${m} min`); // Show mins if it's the only unit or alongside others

                return parts.join(' ');
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden relative">
                    
                    {/* Header */}
                    <div className="absolute top-0 left-0 right-0 z-20 p-4 pointer-events-none">
                        <div className="flex justify-between items-start">
                            <div className="bg-white/90 backdrop-blur shadow-lg border border-white/50 p-2 rounded-xl pointer-events-auto">
                                <h1 className="text-sm font-black text-slate-800 flex items-center gap-2">
                                    <span className="text-[#FFCC00]"><Icons.Truck size={20}/></span>
                                    GeoGuard
                                </h1>
                            </div>
                            
                            <div className="flex gap-2 pointer-events-auto">
                                <div className="bg-white/90 backdrop-blur shadow-lg p-1 rounded-lg flex gap-1">
                                    <button onClick={() => setView('admin')} className={`px-3 py-1.5 rounded text-xs font-bold transition-colors ${view === 'admin' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}>Admin</button>
                                    <button onClick={() => setView('driver')} className={`px-3 py-1.5 rounded text-xs font-bold transition-colors ${view === 'driver' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}>Driver</button>
                                </div>
                                
                                {view === 'admin' && (
                                    <button 
                                        onClick={() => setIsSidebarOpen(true)}
                                        className="bg-white/90 backdrop-blur shadow-lg p-2 rounded-lg text-slate-700 hover:bg-slate-100"
                                    >
                                        <Icons.Menu size={20} />
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* STATUS TOGGLE - FIXED TOP CENTER */}
                    <div className="absolute top-20 left-1/2 -translate-x-1/2 z-20 pointer-events-auto">
                        <div className="flex items-center bg-white/90 backdrop-blur-md shadow-xl rounded-full p-1.5 border border-white/50">
                            <button 
                                onClick={() => setStatus('PICKUP')}
                                className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${status === 'PICKUP' ? 'bg-[#FFCC00] text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                PICKUP
                            </button>
                            <span className="text-slate-300 mx-1"><Icons.Navigation size={12} className="rotate-90"/></span>
                            <button 
                                onClick={() => setStatus('DROP')}
                                className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${status === 'DROP' ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                            >
                                DROP
                            </button>
                        </div>
                    </div>

                    {/* RIGHT SIDEBAR (ADDRESS FORMS) */}
                    <div className={`fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-40 transform transition-transform duration-300 ease-in-out ${isSidebarOpen && view === 'admin' ? 'translate-x-0' : 'translate-x-full'}`}>
                        <div className="h-full flex flex-col">
                            <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-slate-50">
                                <h2 className="font-bold text-slate-800 uppercase text-xs tracking-widest">Order Settings</h2>
                                <button onClick={() => setIsSidebarOpen(false)} className="text-slate-400 hover:text-red-500 transition-colors">
                                    <Icons.X size={20} />
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-4 space-y-6">
                                <div>
                                    <h3 className="text-[10px] font-bold text-slate-400 uppercase mb-2">Origin</h3>
                                    <AddressForm 
                                        type="pickup" 
                                        data={pickup} 
                                        onChange={setPickup} 
                                        onCoordsUpdate={(lat, lng) => setPickup(prev => ({ ...prev, lat, lng }))}
                                    />
                                </div>
                                <div className="flex justify-center">
                                    <div className="bg-slate-100 p-1.5 rounded-full"><Icons.Navigation size={16} className="text-slate-300 rotate-180"/></div>
                                </div>
                                <div>
                                    <h3 className="text-[10px] font-bold text-slate-400 uppercase mb-2">Destination</h3>
                                    <AddressForm 
                                        type="drop" 
                                        data={drop} 
                                        onChange={setDrop} 
                                        onCoordsUpdate={(lat, lng) => setDrop(prev => ({ ...prev, lat, lng }))}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* OVERLAY FOR SIDEBAR */}
                    {isSidebarOpen && view === 'admin' && (
                        <div 
                            className="fixed inset-0 bg-black/20 z-30 backdrop-blur-[1px]" 
                            onClick={() => setIsSidebarOpen(false)}
                        ></div>
                    )}

                    {/* Map Layer */}
                    <div className="flex-1 relative z-0">
                        <MapComponent 
                            targetLat={activeTarget.lat} 
                            targetLng={activeTarget.lng}
                            radius={activeTarget.radius}
                            driverLocation={driverLocation}
                            driverAccuracy={driverAccuracy}
                            onRouteFound={(dist, time) => setRouteStats({ distance: dist, time: time })}
                        />
                    </div>

                    {/* DRIVER BOTTOM PANEL */}
                    {view === 'driver' && (
                        <div className="bg-white z-10 border-t border-gray-200 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                            <div className="max-w-md mx-auto p-4">
                                <div className="text-center space-y-4">
                                    <div className="flex items-center justify-between">
                                        <div className="text-left">
                                            <h2 className="text-lg font-black text-slate-800">
                                                {status === 'PICKUP' ? 'Head to Pickup' : 'Head to Drop'}
                                            </h2>
                                            <p className="text-xs text-slate-500 font-medium mt-1">
                                                {status === 'PICKUP' 
                                                    ? (pickup.lat ? `${pickup.locality}, ${pickup.district}` : 'Waiting for dispatcher...') 
                                                    : (drop.lat ? `${drop.locality}, ${drop.district}` : 'Waiting for drop details...')
                                                }
                                            </p>
                                        </div>
                                        {driverAccuracy && (
                                            <div className={`flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold ${driverAccuracy > 100 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                                {driverAccuracy > 100 ? <Icons.WifiOff size={10} /> : <Icons.Crosshair size={10} />}
                                                Â±{Math.round(driverAccuracy)}m
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex gap-4 justify-center">
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-100 min-w-[80px]">
                                            <span className="block text-[10px] text-slate-400 font-bold uppercase">Dist</span>
                                            <span className="block text-xl font-black text-slate-800">
                                                {(routeStats.distance / 1000).toFixed(1)} <span className="text-xs font-medium text-slate-400">km</span>
                                            </span>
                                        </div>
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-100 min-w-[80px]">
                                            <span className="block text-[10px] text-slate-400 font-bold uppercase">ETA</span>
                                            <span className="block text-lg font-black text-slate-800 truncate max-w-[120px]" title={formatTime(routeStats.time)}>
                                                {formatTime(routeStats.time)}
                                            </span>
                                        </div>
                                    </div>

                                    <button 
                                        onClick={handleDriverCheckIn}
                                        disabled={driverSearching}
                                        className="w-full bg-[#FFCC00] hover:bg-[#E6B800] text-slate-900 py-4 rounded-xl font-black uppercase tracking-widest text-sm shadow-lg shadow-amber-200 transition-transform active:scale-95 flex items-center justify-center gap-2"
                                    >
                                        {driverSearching ? <Icons.Loader2 className="animate-spin"/> : <Icons.Navigation />}
                                        {driverLocation ? 'Update Location' : 'Start Navigation'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GeoFenceApp />);
    </script>
</body>

</html>
